{% extends "_base.html" %}
{% block content %}

<h3 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>Admin Dashboard</h3>

<div class="row g-3 mb-4">

  <!-- T·ªïng nh√¢n vi√™n -->
  <div class="col-md-3">
    <div class="card shadow-sm text-center p-3 h-100">
      <div class="d-flex flex-column justify-content-between h-100">
        <div>
          <i class="bi bi-people display-5 text-primary"></i>
          <div class="fw-bold mt-2">T·ªïng nh√¢n vi√™n</div>
        </div>

        <div class="display-6">{{ total_users }}</div>

        <!-- gi·ªØ ch·ªó cho ƒë·ªìng ƒë·ªÅu -->
        <small class="text-muted">&nbsp;</small>
      </div>
    </div>
  </div>

  <!-- T·ªïng b·∫£n ghi -->
  <div class="col-md-3">
    <div class="card shadow-sm text-center p-3 h-100">
      <div class="d-flex flex-column justify-content-between h-100">
        <div>
          <i class="bi bi-journal-text display-5 text-success"></i>
          <div class="fw-bold mt-2">T·ªïng b·∫£n ghi</div>
        </div>

        <div class="display-6">{{ total_logs }}</div>

        <!-- gi·ªØ ch·ªó cho ƒë·ªìng ƒë·ªÅu -->
        <small class="text-muted">&nbsp;</small>
      </div>
    </div>
  </div>

  <!-- T·ªïng gi·ªù h√¥m nay -->
  <div class="col-md-3">
    <div class="card shadow-sm text-center p-3 h-100">
      <div class="d-flex flex-column justify-content-between h-100">
        <div>
          <i class="bi bi-clock display-5 text-warning"></i>
          <div class="fw-bold mt-2">T·ªïng gi·ªù h√¥m nay</div>
        </div>

        <div class="display-6">{{ total_hours_today or 0 }}h</div>

        <small class="text-muted">
          Trung b√¨nh: {{ avg_hours_per_employee or 0 }}h/ng∆∞·ªùi
        </small>
      </div>
    </div>
  </div>

  <!-- ƒêi tr·ªÖ h√¥m nay -->
  <div class="col-md-3">
    <div class="card shadow-sm text-center p-3 h-100">
      <div class="d-flex flex-column justify-content-between h-100">
        <div>
          <i class="bi bi-exclamation-triangle display-5 text-danger"></i>
          <div class="fw-bold mt-2">S·ªë nh√¢n vi√™n ƒëi tr·ªÖ</div>
        </div>

        <div class="display-6">{{ late_today or 0 }}</div>

        <small class="text-muted">(Theo quy ƒë·ªãnh 8:00)</small>
      </div>
    </div>
  </div>

</div>


<!-- Bi·ªÉu ƒë·ªì gi·ªù l√†m trong th√°ng + controls -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">
        <i class="bi bi-bar-chart-line me-2"></i>
        Th·ªëng k√™ l∆∞·ª£t check-in ({{ current_month or "Th√°ng n√†y" }})
      </h5>
      <div class="d-flex gap-2">
        <a href="{{ url_for('web_ui.export_data') }}" class="btn btn-sm btn-success">
          <i class="bi bi-file-earmark-arrow-down"></i> Xu·∫•t Excel
        </a>
        <a href="{{ url_for('web_ui.admin_users') }}" class="btn btn-sm btn-secondary">
          <i class="bi bi-people"></i> Danh s√°ch nh√¢n vi√™n
        </a>
      </div>
    </div>

    <canvas id="workChart" height="120"></canvas>

    <div class="mt-3">
      <small class="text-muted">
        M·ªói c·ªôt th·ªÉ hi·ªán s·ªë l∆∞·ª£t check-in trong ng√†y.
        M√†u xanh = ho·∫°t ƒë·ªông nhi·ªÅu, v√†ng = trung b√¨nh, ƒë·ªè = √≠t ho·∫°t ƒë·ªông.
      </small>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const days = {{ chart_days | tojson }};
  const values = {{ chart_values | tojson }};

  const ctx = document.getElementById('workChart').getContext('2d');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: days,
      datasets: [{
        label: 'S·ªë l∆∞·ª£t check-in',
        data: values,
        backgroundColor: values.map(v =>
          v >= 3 ? 'rgba(34,197,94,0.85)' :   // ho·∫°t ƒë·ªông t·ªët
          v === 2 ? 'rgba(250,204,21,0.85)' : // trung b√¨nh
                    'rgba(239,68,68,0.8)'     // √≠t / kh√¥ng ho·∫°t ƒë·ªông
        ),
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.raw} l∆∞·ª£t check-in`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'S·ªë l∆∞·ª£t' }
        },
        x: {
          title: { display: true, text: 'Ng√†y trong th√°ng' }
        }
      }
    }
  });
</script>


<!-- Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y -->
<div class="card shadow-sm mt-4 mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h5>
      <div>
        <a href="{{ url_for('web_ui.attendance_page') }}" class="btn btn-sm btn-outline-primary">
          Xem chi ti·∫øt
        </a>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Nh√¢n vi√™n</th>
            <th>H√†nh ƒë·ªông</th>
            <th>Th·ªùi gian</th>
            <th>Tr·∫°ng th√°i</th>
          </tr>
        </thead>
        <tbody>
          {% for r in recent %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.user.full_name or r.user.username }}</td>
            <td>
              <span class="badge {% if r.action == 'checkin' %}bg-warning text-dark{% else %}bg-success{% endif %}">
                {{ 'Check-in' if r.action=='checkin' else 'Check-out' }}
              </span>
            </td>
            <td>{{ r.timestamp.strftime("%H:%M %d/%m/%Y") }}</td>
            <td>
              {% if r.action == 'checkin' %}
                <span class="badge bg-warning text-dark">ƒêang l√†m</span>
              {% elif r.action == 'checkout' %}
                <span class="badge bg-success">
                  Ho√†n th√†nh ({{ "%.2f"|format(r.work_hours) if r.work_hours else "?" }}h)
                </span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>
<div class="card shadow-sm mb-5">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0"><i class="bi bi-calendar3 me-2"></i>B·∫£ng ch·∫•m c√¥ng theo th√°ng (nhanh)</h5>
      <div class="d-flex gap-2 align-items-center">
        <form method="get" class="d-flex gap-2 align-items-center" action="{{ url_for('web_ui.user_month_view') }}">
          <select name="user_id" class="form-select form-select-sm" style="width:220px">
            <option value="">‚Äî Ch·ªçn nh√¢n vi√™n ‚Äî</option>
            {% for u in users_for_select %}
              <option value="{{ u.id }}">{{ u.full_name or u.username }} ({{ u.department or '‚Äî' }})</option>
            {% endfor %}
          </select>
          <select name="month" class="form-select form-select-sm" style="width:140px">
            {% for m in months %}
              <option value="{{ m.value }}" {% if m.value==current_month_num %}selected{% endif %}>{{ m.label }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-sm btn-primary">Xem</button>
        </form>

        <a href="{{ url_for('web_ui.export_data') }}" class="btn btn-sm btn-outline-success">
          Export to√†n b·ªô (Excel)
        </a>
      </div>
    </div>
    <small class="text-muted">
      Ch·ªçn nh√¢n vi√™n ƒë·ªÉ xem l∆∞·ªõi ng√†y (m·ªói √¥ = 1 ng√†y).
      üü¢ Xanh = ƒë·ªß check-in & check-out |
      üü° V√†ng = ƒë√£ check-in |
      üî¥ ƒê·ªè = ch∆∞a ch·∫•m c√¥ng
    </small>
  </div>
</div>

{% endblock %}
